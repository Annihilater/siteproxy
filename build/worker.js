var we={Stringify:1,BeforeStream:2,Stream:3},Ve=(e,t)=>{let s=new String(e);return s.isEscaped=!0,s.callbacks=t,s};var ae=async(e,t,s,r,o)=>{let n=e.callbacks;if(!n?.length)return Promise.resolve(e);o?o[0]+=e:o=[e];let i=Promise.all(n.map(c=>c({phase:t,buffer:o,context:r}))).then(c=>Promise.all(c.filter(Boolean).map(a=>ae(a,t,!1,r,o))).then(()=>o[0]));return s?Ve(await i,n):i};var ve=(e,t,s)=>{if(!t.has(e))throw TypeError("Cannot "+s)},d=(e,t,s)=>(ve(e,t,"read from private field"),s?s.call(e):t.get(e)),U=(e,t,s)=>{if(t.has(e))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(e):t.set(e,s)},v=(e,t,s,r)=>(ve(e,t,"write to private field"),r?r.call(e,s):t.set(e,s),s),Qe="text/plain; charset=UTF-8",ce=(e,t={})=>(Object.entries(t).forEach(([s,r])=>e.set(s,r)),e),W,I,y,u,$,N,B=class{constructor(e,t){this.env={},this._var={},this.finalized=!1,this.error=void 0,U(this,W,200),U(this,I,void 0),U(this,y,void 0),U(this,u,void 0),U(this,$,void 0),U(this,N,!0),this.layout=void 0,this.renderer=s=>this.html(s),this.notFoundHandler=()=>new Response,this.render=(...s)=>this.renderer(...s),this.setLayout=s=>this.layout=s,this.getLayout=()=>this.layout,this.setRenderer=s=>{this.renderer=s},this.header=(s,r,o)=>{if(r===void 0){d(this,y)?d(this,y).delete(s):d(this,u)&&delete d(this,u)[s.toLocaleLowerCase()],this.finalized&&this.res.headers.delete(s);return}o?.append?(d(this,y)||(v(this,N,!1),v(this,y,new Headers(d(this,u))),v(this,u,{})),d(this,y).append(s,r)):d(this,y)?d(this,y).set(s,r):(d(this,u)??v(this,u,{}),d(this,u)[s.toLowerCase()]=r),this.finalized&&(o?.append?this.res.headers.append(s,r):this.res.headers.set(s,r))},this.status=s=>{v(this,N,!1),v(this,W,s)},this.set=(s,r)=>{this._var??(this._var={}),this._var[s]=r},this.get=s=>this._var?this._var[s]:void 0,this.newResponse=(s,r,o)=>{if(d(this,N)&&!o&&!r&&d(this,W)===200)return new Response(s,{headers:d(this,u)});if(r&&typeof r!="number"){let i=ce(new Headers(r.headers),d(this,u));return new Response(s,{headers:i,status:r.status??d(this,W)})}let n=typeof r=="number"?r:d(this,W);d(this,u)??v(this,u,{}),d(this,y)??v(this,y,new Headers),ce(d(this,y),d(this,u)),d(this,$)&&(d(this,$).headers.forEach((i,c)=>{d(this,y)?.set(c,i)}),ce(d(this,y),d(this,u))),o??(o={});for(let[i,c]of Object.entries(o))if(typeof c=="string")d(this,y).set(i,c);else{d(this,y).delete(i);for(let a of c)d(this,y).append(i,a)}return new Response(s,{status:n,headers:d(this,y)})},this.body=(s,r,o)=>typeof r=="number"?this.newResponse(s,r,o):this.newResponse(s,r),this.text=(s,r,o)=>{if(!d(this,u)){if(d(this,N)&&!o&&!r)return new Response(s);v(this,u,{})}return d(this,u)["content-type"]=Qe,typeof r=="number"?this.newResponse(s,r,o):this.newResponse(s,r)},this.json=(s,r,o)=>{let n=JSON.stringify(s);return d(this,u)??v(this,u,{}),d(this,u)["content-type"]="application/json; charset=UTF-8",typeof r=="number"?this.newResponse(n,r,o):this.newResponse(n,r)},this.html=(s,r,o)=>(d(this,u)??v(this,u,{}),d(this,u)["content-type"]="text/html; charset=UTF-8",typeof s=="object"&&(s instanceof Promise||(s=s.toString()),s instanceof Promise)?s.then(n=>ae(n,we.Stringify,!1,{})).then(n=>typeof r=="number"?this.newResponse(n,r,o):this.newResponse(n,r)):typeof r=="number"?this.newResponse(s,r,o):this.newResponse(s,r)),this.redirect=(s,r=302)=>(d(this,y)??v(this,y,new Headers),d(this,y).set("Location",s),this.newResponse(null,r)),this.notFound=()=>this.notFoundHandler(this),this.req=e,t&&(v(this,I,t.executionCtx),this.env=t.env,t.notFoundHandler&&(this.notFoundHandler=t.notFoundHandler))}get event(){if(d(this,I)&&"respondWith"in d(this,I))return d(this,I);throw Error("This context has no FetchEvent")}get executionCtx(){if(d(this,I))return d(this,I);throw Error("This context has no ExecutionContext")}get res(){return v(this,N,!1),d(this,$)||v(this,$,new Response("404 Not Found",{status:404}))}set res(e){if(v(this,N,!1),d(this,$)&&e){d(this,$).headers.delete("content-type");for(let[t,s]of d(this,$).headers.entries())if(t==="set-cookie"){let r=d(this,$).headers.getSetCookie();e.headers.delete("set-cookie");for(let o of r)e.headers.append("set-cookie",o)}else e.headers.set(t,s)}v(this,$,e),this.finalized=!0}get var(){return{...this._var}}};W=new WeakMap;I=new WeakMap;y=new WeakMap;u=new WeakMap;$=new WeakMap;N=new WeakMap;var xe=(e,t,s)=>(r,o)=>{let n=-1;return i(0);async function i(c){if(c<=n)throw new Error("next() called multiple times");n=c;let a,x=!1,_;if(e[c]?(_=e[c][0][0],r instanceof B&&(r.req.routeIndex=c)):_=c===e.length&&o||void 0,!_)r instanceof B&&r.finalized===!1&&s&&(a=await s(r));else try{a=await _(r,()=>i(c+1))}catch(f){if(f instanceof Error&&r instanceof B&&t)r.error=f,a=await t(f,r),x=!0;else throw f}return a&&(r.finalized===!1||x)&&(r.res=a),r}};var Re=class extends Error{constructor(e=500,t){super(t?.message),this.res=t?.res,this.status=e}getResponse(){return this.res?this.res:new Response(this.message,{status:this.status})}};var Ee=async(e,t={all:!1})=>{let r=(e instanceof Y?e.raw.headers:e.headers).get("Content-Type");return Je(r)?Ze(e,t):{}};function Je(e){return e===null?!1:e.startsWith("multipart/form-data")||e.startsWith("application/x-www-form-urlencoded")}async function Ze(e,t){let s=await e.formData();return s?et(s,t):{}}function et(e,t){let s={};return e.forEach((r,o)=>{t.all||o.endsWith("[]")?tt(s,o,r):s[o]=r}),s}var tt=(e,t,s)=>{e[t]&&rt(e[t])?st(e[t],s):e[t]?ot(e,t,s):e[t]=s};function rt(e){return Array.isArray(e)}var st=(e,t)=>{e.push(t)},ot=(e,t,s)=>{e[t]=[e[t],s]};var fe=e=>{let t=e.split("/");return t[0]===""&&t.shift(),t},ke=e=>{let{groups:t,path:s}=nt(e),r=fe(s);return it(r,t)},nt=e=>{let t=[];return e=e.replace(/\{[^}]+\}/g,(s,r)=>{let o=`@${r}`;return t.push([o,s]),o}),{groups:t,path:e}},it=(e,t)=>{for(let s=t.length-1;s>=0;s--){let[r]=t[s];for(let o=e.length-1;o>=0;o--)if(e[o].includes(r)){e[o]=e[o].replace(r,t[s][1]);break}}return e},V={},de=e=>{if(e==="*")return"*";let t=e.match(/^\:([^\{\}]+)(?:\{(.+)\})?$/);return t?(V[e]||(t[2]?V[e]=[e,t[1],new RegExp("^"+t[2]+"$")]:V[e]=[e,t[1],!0]),V[e]):null},le=e=>{let t=e.url.match(/^https?:\/\/[^/]+(\/[^?]*)/);return t?t[1]:""},Se=e=>{let t=e.indexOf("?",8);return t===-1?"":"?"+e.slice(t+1)},Oe=e=>{let t=le(e);return t.length>1&&t[t.length-1]==="/"?t.slice(0,-1):t},F=(...e)=>{let t="",s=!1;for(let r of e)t[t.length-1]==="/"&&(t=t.slice(0,-1),s=!0),r[0]!=="/"&&(r=`/${r}`),r==="/"&&s?t=`${t}/`:r!=="/"&&(t=`${t}${r}`),r==="/"&&t===""&&(t="/");return t},Q=e=>{if(!e.match(/\:.+\?$/))return null;let t=e.split("/"),s=[],r="";return t.forEach(o=>{if(o!==""&&!/\:/.test(o))r+="/"+o;else if(/\:/.test(o))if(/\?/.test(o)){s.length===0&&r===""?s.push("/"):s.push(r);let n=o.replace("?","");r+="/"+n,s.push(r)}else r+="/"+o}),s.filter((o,n,i)=>i.indexOf(o)===n)},_e=e=>/[%+]/.test(e)?(e.indexOf("+")!==-1&&(e=e.replace(/\+/g," ")),/%/.test(e)?J(e):e):e,He=(e,t,s)=>{let r;if(!s&&t&&!/[%+]/.test(t)){let i=e.indexOf(`?${t}`,8);for(i===-1&&(i=e.indexOf(`&${t}`,8));i!==-1;){let c=e.charCodeAt(i+t.length+1);if(c===61){let a=i+t.length+2,x=e.indexOf("&",a);return _e(e.slice(a,x===-1?void 0:x))}else if(c==38||isNaN(c))return"";i=e.indexOf(`&${t}`,i+1)}if(r=/[%+]/.test(e),!r)return}let o={};r??(r=/[%+]/.test(e));let n=e.indexOf("?",8);for(;n!==-1;){let i=e.indexOf("&",n+1),c=e.indexOf("=",n);c>i&&i!==-1&&(c=-1);let a=e.slice(n+1,c===-1?i===-1?void 0:i:c);if(r&&(a=_e(a)),n=i,a==="")continue;let x;c===-1?x="":(x=e.slice(c+1,i===-1?void 0:i),r&&(x=_e(x))),s?(o[a]&&Array.isArray(o[a])||(o[a]=[]),o[a].push(x)):o[a]??(o[a]=x)}return t?o[t]:o},Ce=He,Ae=(e,t)=>He(e,t,!0),J=decodeURIComponent;var Me=(e,t,s)=>{if(!t.has(e))throw TypeError("Cannot "+s)},L=(e,t,s)=>(Me(e,t,"read from private field"),s?s.call(e):t.get(e)),$e=(e,t,s)=>{if(t.has(e))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(e):t.set(e,s)},Pe=(e,t,s,r)=>(Me(e,t,"write to private field"),r?r.call(e,s):t.set(e,s),s),z,M,Y=class{constructor(e,t="/",s=[[]]){$e(this,z,void 0),$e(this,M,void 0),this.routeIndex=0,this.bodyCache={},this.cachedBody=r=>{let{bodyCache:o,raw:n}=this,i=o[r];return i||(o.arrayBuffer?(async()=>await new Response(o.arrayBuffer)[r]())():o[r]=n[r]())},this.raw=e,this.path=t,Pe(this,M,s),Pe(this,z,{})}param(e){return e?this.getDecodedParam(e):this.getAllDecodedParams()}getDecodedParam(e){let t=L(this,M)[0][this.routeIndex][1][e],s=this.getParamValue(t);return s?/\%/.test(s)?J(s):s:void 0}getAllDecodedParams(){let e={},t=Object.keys(L(this,M)[0][this.routeIndex][1]);for(let s of t){let r=this.getParamValue(L(this,M)[0][this.routeIndex][1][s]);r&&typeof r=="string"&&(e[s]=/\%/.test(r)?J(r):r)}return e}getParamValue(e){return L(this,M)[1]?L(this,M)[1][e]:e}query(e){return Ce(this.url,e)}queries(e){return Ae(this.url,e)}header(e){if(e)return this.raw.headers.get(e.toLowerCase())??void 0;let t={};return this.raw.headers.forEach((s,r)=>{t[r]=s}),t}async parseBody(e){if(this.bodyCache.parsedBody)return this.bodyCache.parsedBody;let t=await Ee(this,e);return this.bodyCache.parsedBody=t,t}json(){return this.cachedBody("json")}text(){return this.cachedBody("text")}arrayBuffer(){return this.cachedBody("arrayBuffer")}blob(){return this.cachedBody("blob")}formData(){return this.cachedBody("formData")}addValidatedData(e,t){L(this,z)[e]=t}valid(e){return L(this,z)[e]}get url(){return this.raw.url}get method(){return this.raw.method}get matchedRoutes(){return L(this,M)[0].map(([[,e]])=>e)}get routePath(){return L(this,M)[0].map(([[,e]])=>e)[this.routeIndex].path}};z=new WeakMap;M=new WeakMap;var m="ALL",Te="all",Z=["get","post","put","delete","options","patch"],ee="Can not add a route since the matcher is already built.",te=class extends Error{};var Ie=(e,t,s)=>{if(!t.has(e))throw TypeError("Cannot "+s)},re=(e,t,s)=>(Ie(e,t,"read from private field"),s?s.call(e):t.get(e)),at=(e,t,s)=>{if(t.has(e))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(e):t.set(e,s)},se=(e,t,s,r)=>(Ie(e,t,"write to private field"),r?r.call(e,s):t.set(e,s),s),ct=Symbol("composedHandler");function xt(){return class{}}var _t=e=>e.text("404 Not Found",404),Le=(e,t)=>e instanceof Re?e.getResponse():(console.error(e),t.text("Internal Server Error",500)),T,Ne=class extends xt(){constructor(e={}){super(),this._basePath="/",at(this,T,"/"),this.routes=[],this.notFoundHandler=_t,this.errorHandler=Le,this.onError=r=>(this.errorHandler=r,this),this.notFound=r=>(this.notFoundHandler=r,this),this.fetch=(r,o,n)=>this.dispatch(r,n,o,r.method),this.request=(r,o,n,i)=>{if(r instanceof Request)return o!==void 0&&(r=new Request(r,o)),this.fetch(r,n,i);r=r.toString();let c=/^https?:\/\//.test(r)?r:`http://localhost${F("/",r)}`,a=new Request(c,o);return this.fetch(a,n,i)},this.fire=()=>{addEventListener("fetch",r=>{r.respondWith(this.dispatch(r.request,r,void 0,r.request.method))})},[...Z,Te].map(r=>{this[r]=(o,...n)=>(typeof o=="string"?se(this,T,o):this.addRoute(r,re(this,T),o),n.map(i=>{typeof i!="string"&&this.addRoute(r,re(this,T),i)}),this)}),this.on=(r,o,...n)=>{if(!r)return this;for(let i of[o].flat()){se(this,T,i);for(let c of[r].flat())n.map(a=>{this.addRoute(c.toUpperCase(),re(this,T),a)})}return this},this.use=(r,...o)=>(typeof r=="string"?se(this,T,r):(se(this,T,"*"),o.unshift(r)),o.map(n=>{this.addRoute(m,re(this,T),n)}),this);let s=e.strict??!0;delete e.strict,Object.assign(this,e),this.getPath=s?e.getPath??le:Oe}clone(){let e=new Ne({router:this.router,getPath:this.getPath});return e.routes=this.routes,e}route(e,t){let s=this.basePath(e);return t?(t.routes.map(r=>{let o;t.errorHandler===Le?o=r.handler:(o=async(n,i)=>(await xe([],t.errorHandler)(n,()=>r.handler(n,i))).res,o[ct]=r.handler),s.addRoute(r.method,r.path,o)}),this):s}basePath(e){let t=this.clone();return t._basePath=F(this._basePath,e),t}mount(e,t,s){let r=F(this._basePath,e),o=r==="/"?0:r.length,n=async(i,c)=>{let a;try{a=i.executionCtx}catch{}let x=s?s(i):[i.env,a],_=Array.isArray(x)?x:[x],f=Se(i.req.url),h=await t(new Request(new URL((i.req.path.slice(o)||"/")+f,i.req.url),i.req.raw),..._);if(h)return h;await c()};return this.addRoute(m,F(e,"*"),n),this}addRoute(e,t,s){e=e.toUpperCase(),t=F(this._basePath,t);let r={path:t,method:e,handler:s};this.router.add(e,t,[s,r]),this.routes.push(r)}matchRoute(e,t){return this.router.match(e,t)}handleError(e,t){if(e instanceof Error)return this.errorHandler(e,t);throw e}dispatch(e,t,s,r){if(r==="HEAD")return(async()=>new Response(null,await this.dispatch(e,t,s,"GET")))();let o=this.getPath(e,{env:s}),n=this.matchRoute(r,o),i=new B(new Y(e,o,n),{env:s,executionCtx:t,notFoundHandler:this.notFoundHandler});if(n[0].length===1){let a;try{a=n[0][0][0][0](i,async()=>{i.res=await this.notFoundHandler(i)})}catch(x){return this.handleError(x,i)}return a instanceof Promise?a.then(x=>x||(i.finalized?i.res:this.notFoundHandler(i))).catch(x=>this.handleError(x,i)):a}let c=xe(n[0],this.errorHandler,this.notFoundHandler);return(async()=>{try{let a=await c(i);if(!a.finalized)throw new Error("Context is not finalized. You may forget returning Response object or `await next()`");return a.res}catch(a){return this.handleError(a,i)}})()}},De=Ne;T=new WeakMap;var oe="[^/]+",G=".*",K="(?:|/.*)",j=Symbol();function ft(e,t){return e.length===1?t.length===1?e<t?-1:1:-1:t.length===1||e===G||e===K?1:t===G||t===K?-1:e===oe?1:t===oe?-1:e.length===t.length?e<t?-1:1:t.length-e.length}var ne=class{constructor(){this.children={}}insert(e,t,s,r,o){if(e.length===0){if(this.index!==void 0)throw j;if(o)return;this.index=t;return}let[n,...i]=e,c=n==="*"?i.length===0?["","",G]:["","",oe]:n==="/*"?["","",K]:n.match(/^\:([^\{\}]+)(?:\{(.+)\})?$/),a;if(c){let x=c[1],_=c[2]||oe;if(x&&c[2]&&(_=_.replace(/^\((?!\?:)(?=[^)]+\)$)/,"(?:"),/\((?!\?:)/.test(_)))throw j;if(a=this.children[_],!a){if(Object.keys(this.children).some(f=>f!==G&&f!==K))throw j;if(o)return;a=this.children[_]=new ne,x!==""&&(a.varIndex=r.varIndex++)}!o&&x!==""&&s.push([x,a.varIndex])}else if(a=this.children[n],!a){if(Object.keys(this.children).some(x=>x.length>1&&x!==G&&x!==K))throw j;if(o)return;a=this.children[n]=new ne}a.insert(i,t,s,r,o)}buildRegExpStr(){let t=Object.keys(this.children).sort(ft).map(s=>{let r=this.children[s];return(typeof r.varIndex=="number"?`(${s})@${r.varIndex}`:s)+r.buildRegExpStr()});return typeof this.index=="number"&&t.unshift(`#${this.index}`),t.length===0?"":t.length===1?t[0]:"(?:"+t.join("|")+")"}};var Ue=class{constructor(){this.context={varIndex:0},this.root=new ne}insert(e,t,s){let r=[],o=[];for(let i=0;;){let c=!1;if(e=e.replace(/\{[^}]+\}/g,a=>{let x=`@\\${i}`;return o[i]=[x,a],i++,c=!0,x}),!c)break}let n=e.match(/(?::[^\/]+)|(?:\/\*$)|./g)||[];for(let i=o.length-1;i>=0;i--){let[c]=o[i];for(let a=n.length-1;a>=0;a--)if(n[a].indexOf(c)!==-1){n[a]=n[a].replace(c,o[i][1]);break}}return this.root.insert(n,t,r,this.context,s),r}buildRegExp(){let e=this.root.buildRegExpStr();if(e==="")return[/^$/,[],[]];let t=0,s=[],r=[];return e=e.replace(/#(\d+)|@(\d+)|\.\*\$/g,(o,n,i)=>typeof n<"u"?(s[++t]=Number(n),"$()"):(typeof i<"u"&&(r[Number(i)]=++t),"")),[new RegExp(`^${e}`),s,r]}};var he=[m,...Z].map(e=>e.toUpperCase()),We=[],dt=[/^$/,[],{}],pe={};function Be(e){return pe[e]??(pe[e]=new RegExp(e==="*"?"":`^${e.replace(/\/\*/,"(?:|/.*)")}$`))}function lt(){pe={}}function ht(e){let t=new Ue,s=[];if(e.length===0)return dt;let r=e.map(x=>[!/\*|\/:/.test(x[0]),...x]).sort(([x,_],[f,h])=>x?1:f?-1:_.length-h.length),o={};for(let x=0,_=-1,f=r.length;x<f;x++){let[h,w,b]=r[x];h?o[w]=[b.map(([l])=>[l,{}]),We]:_++;let g;try{g=t.insert(w,_,h)}catch(l){throw l===j?new te(w):l}h||(s[_]=b.map(([l,R])=>{let C={};for(R-=1;R>=0;R--){let[A,S]=g[R];C[A]=S}return[l,C]}))}let[n,i,c]=t.buildRegExp();for(let x=0,_=s.length;x<_;x++)for(let f=0,h=s[x].length;f<h;f++){let w=s[x][f]?.[1];if(!w)continue;let b=Object.keys(w);for(let g=0,l=b.length;g<l;g++)w[b[g]]=c[w[b[g]]]}let a=[];for(let x in i)a[x]=s[i[x]];return[n,a,o]}function q(e,t){if(e){for(let s of Object.keys(e).sort((r,o)=>o.length-r.length))if(Be(s).test(t))return[...e[s]]}}var ue=class{constructor(){this.name="RegExpRouter",this.middleware={[m]:{}},this.routes={[m]:{}}}add(e,t,s){var r;let{middleware:o,routes:n}=this;if(!o||!n)throw new Error(ee);he.indexOf(e)===-1&&he.push(e),o[e]||[o,n].forEach(a=>{a[e]={},Object.keys(a[m]).forEach(x=>{a[e][x]=[...a[m][x]]})}),t==="/*"&&(t="*");let i=(t.match(/\/:/g)||[]).length;if(/\*$/.test(t)){let a=Be(t);e===m?Object.keys(o).forEach(x=>{var _;(_=o[x])[t]||(_[t]=q(o[x],t)||q(o[m],t)||[])}):(r=o[e])[t]||(r[t]=q(o[e],t)||q(o[m],t)||[]),Object.keys(o).forEach(x=>{(e===m||e===x)&&Object.keys(o[x]).forEach(_=>{a.test(_)&&o[x][_].push([s,i])})}),Object.keys(n).forEach(x=>{(e===m||e===x)&&Object.keys(n[x]).forEach(_=>a.test(_)&&n[x][_].push([s,i]))});return}let c=Q(t)||[t];for(let a=0,x=c.length;a<x;a++){let _=c[a];Object.keys(n).forEach(f=>{var h;(e===m||e===f)&&((h=n[f])[_]||(h[_]=[...q(o[f],_)||q(o[m],_)||[]]),n[f][_].push([s,i-x+a+1]))})}}match(e,t){lt();let s=this.buildAllMatchers();return this.match=(r,o)=>{let n=s[r],i=n[2][o];if(i)return i;let c=o.match(n[0]);if(!c)return[[],We];let a=c.indexOf("",1);return[n[1][a],c]},this.match(e,t)}buildAllMatchers(){let e={};return he.forEach(t=>{e[t]=this.buildMatcher(t)||e[m]}),this.middleware=this.routes=void 0,e}buildMatcher(e){let t=[],s=e===m;return[this.middleware,this.routes].forEach(r=>{let o=r[e]?Object.keys(r[e]).map(n=>[n,r[e][n]]):[];o.length!==0?(s||(s=!0),t.push(...o)):e!==m&&t.push(...Object.keys(r[m]).map(n=>[n,r[m][n]]))}),s?ht(t):null}};var be=class{constructor(e){this.name="SmartRouter",this.routers=[],this.routes=[],Object.assign(this,e)}add(e,t,s){if(!this.routes)throw new Error(ee);this.routes.push([e,t,s])}match(e,t){if(!this.routes)throw new Error("Fatal error");let{routers:s,routes:r}=this,o=s.length,n=0,i;for(;n<o;n++){let c=s[n];try{r.forEach(a=>{c.add(...a)}),i=c.match(e,t)}catch(a){if(a instanceof te)continue;throw a}this.match=c.match.bind(c),this.routers=[c],this.routes=void 0;break}if(n===o)throw new Error("Fatal error");return this.name=`SmartRouter + ${this.activeRouter.name}`,i}get activeRouter(){if(this.routes||this.routers.length!==1)throw new Error("No active router has been determined yet.");return this.routers[0]}};var me=class{constructor(e,t,s){if(this.order=0,this.params={},this.children=s||{},this.methods=[],this.name="",e&&t){let r={};r[e]={handler:t,possibleKeys:[],score:0,name:this.name},this.methods=[r]}this.patterns=[]}insert(e,t,s){this.name=`${e} ${t}`,this.order=++this.order;let r=this,o=ke(t),n=[],i=[];for(let x=0,_=o.length;x<_;x++){let f=o[x];if(Object.keys(r.children).includes(f)){i.push(...r.patterns),r=r.children[f];let w=de(f);w&&n.push(w[1]);continue}r.children[f]=new me;let h=de(f);h&&(r.patterns.push(h),i.push(...r.patterns),n.push(h[1])),i.push(...r.patterns),r=r.children[f]}r.methods.length||(r.methods=[]);let c={},a={handler:s,possibleKeys:n.filter((x,_,f)=>f.indexOf(x)===_),name:this.name,score:this.order};return c[e]=a,r.methods.push(c),r}gHSets(e,t,s,r){let o=[];for(let n=0,i=e.methods.length;n<i;n++){let c=e.methods[n],a=c[t]||c[m],x={};a!==void 0&&(a.params={},a.possibleKeys.forEach(_=>{let f=x[a.name];a.params[_]=r[_]&&!f?r[_]:s[_]??r[_],x[a.name]=!0}),o.push(a))}return o}search(e,t){let s=[];this.params={};let o=[this],n=fe(t);for(let c=0,a=n.length;c<a;c++){let x=n[c],_=c===a-1,f=[];for(let h=0,w=o.length;h<w;h++){let b=o[h],g=b.children[x];g&&(g.params=b.params,_===!0?(g.children["*"]&&s.push(...this.gHSets(g.children["*"],e,b.params,{})),s.push(...this.gHSets(g,e,b.params,{}))):f.push(g));for(let l=0,R=b.patterns.length;l<R;l++){let C=b.patterns[l],A={...b.params};if(C==="*"){let p=b.children["*"];p&&(s.push(...this.gHSets(p,e,b.params,{})),f.push(p));continue}if(x==="")continue;let[S,E,O]=C,H=b.children[S],k=n.slice(c).join("/");if(O instanceof RegExp&&O.test(k)){A[E]=k,s.push(...this.gHSets(H,e,b.params,A));continue}(O===!0||O instanceof RegExp&&O.test(x))&&typeof S=="string"&&(A[E]=x,_===!0?(s.push(...this.gHSets(H,e,A,b.params)),H.children["*"]&&s.push(...this.gHSets(H.children["*"],e,A,b.params))):(H.params=A,f.push(H)))}}o=f}return[s.sort((c,a)=>c.score-a.score).map(({handler:c,params:a})=>[c,a])]}};var ge=class{constructor(){this.name="TrieRouter",this.node=new me}add(e,t,s){let r=Q(t);if(r){for(let o of r)this.node.insert(e,o,s);return}this.node.insert(e,t,s)}match(e,t){return this.node.search(e,t)}};var ye=class extends De{constructor(e={}){super(e),this.router=e.router??new be({routers:[new ue,new ge]})}};function X(e){let t=e.indexOf("/"),s,r;return t&&(s=e.substring(0,t),r=e.substring(t+1).split("/")[0],r.indexOf("?")!==-1&&(r=r.slice(0,r.indexOf("?")))),{protocol:s,host:r}}var D;function pt(){return typeof Bun<"u"||typeof process<"u"&&process.versions&&process.versions.node}function Fe(e){pt()?(console.log("node environment!"),import("fs/promises").then(t=>{t.readFile("./config.json","utf8").then(s=>{D=JSON.parse(s),console.log("Configuration loaded:",D),e(D)}).catch(s=>{console.error("Error loading the configuration file:",s)})})):(console.log("cloudflare environment!"),D={proxy_url:"http://localhost:5006",token_prefix:"/user22334455/",local_listen_port:5006},console.log("Configuration loaded:",D),e(D))}function P(){return D}var ut=[{domain:"accounts.youtube.com",replacements:[{regex:"window.parent.postMessage\\((.*?), .https:.*?;",replacement:"window.parent.postMessage($1);"}]}];function je({body:e,proxy_real_host:t,proxy_url_prefix:s}){let r=ut.find(n=>t.includes(n.domain));if(!r)return e;let o=e;return r.replacements.forEach(({regex:n,replacement:i})=>{let c=i.replace(/\$proxy_url_prefix/g,s);o=o.replace(new RegExp(n,"g"),c)}),o}var ie;var bt=({location_value:e,proxy_url_prefix:t,proxy_real_protocol:s,proxy_real_host:r})=>{let o={"(http[s]?)://([-a-z0-9A-Z.]+)":`${t}$1/$2`};for(let n in o){let i=new RegExp(n,"g");e=e.replace(i,o[n])}return e};function mt({location_value:e,proxy_url_prefix:t,proxy_real_protocol:s,proxy_real_host:r}){return bt({location_value:e,proxy_url_prefix:t,proxy_real_protocol:s,proxy_real_host:r})}function gt(){return typeof Bun<"u"||typeof process<"u"&&process.versions&&process.versions.node}async function yt(e,t){return gt()?await wt(e,t):await vt(e,t)}async function wt(e,t){ie||(ie=await import("zlib"));try{return t==="br"?ie.brotliCompressSync(e):t==="gzip"?ie.gzipSync(e):e}catch(s){return console.error("Compression error:",s),e}}async function vt(e,t){if(typeof CompressionStream<"u")try{let s;if(t==="gzip"||t==="br")s=e.pipeThrough(new CompressionStream(t));else throw new Error("Unsupported encoding for compression");let r=s.getReader(),o=[],n;for(;!(n=await r.read()).done;)o.push(n.value);return new Uint8Array(o.reduce((c,a)=>c.concat(Array.from(a)),[]))}catch(s){return console.error("Compression error:",s),e}else return console.error("Compression not supported in this environment or for the specified format."),e}async function qe({proxyResponse:e,newResHeaders:t,req:s}){let r=P(),o=r.proxy_url+r.token_prefix,n=s.proxy_real_protocol,i=s.proxy_real_host,_=`<script>
          const proxy_url_prefix = '${o}';
          const proxy_real_protocol = '${n}';
          const proxy_real_host = '${i}';
          const config_proxy_url = '${r.proxy_url}';
          const config_token_prefix = '${r.token_prefix}';
        `+"const _0x5c7348=_0x2a6f;(function(_0x4dd98b,_0x1151a3){const _0x37a754=_0x2a6f,_0xca845d=_0x4dd98b();while(!![]){try{const _0x29ee6b=parseInt(_0x37a754(0xbf))/0x1+-parseInt(_0x37a754(0x9b))/0x2+-parseInt(_0x37a754(0xa5))/0x3+parseInt(_0x37a754(0xc3))/0x4+parseInt(_0x37a754(0x8e))/0x5+parseInt(_0x37a754(0x9c))/0x6+-parseInt(_0x37a754(0x9d))/0x7;if(_0x29ee6b===_0x1151a3)break;else _0xca845d['push'](_0xca845d['shift']());}catch(_0x38332b){_0xca845d['push'](_0xca845d['shift']());}}}(_0x36e8,0x5296c),window['proxy_postMessage']=(_0x446c89,..._0x43b5d6)=>{const _0x3714a8=_0x2a6f;let _0x418300='*',_0x38938f;if(_0x43b5d6['length']>0x0&&(typeof _0x43b5d6[_0x43b5d6[_0x3714a8(0xc1)]-0x1]===_0x3714a8(0x8d)&&!(_0x43b5d6[_0x43b5d6['length']-0x1]instanceof String))){const _0x3dbd4b=_0x43b5d6[_0x3714a8(0xd6)]();_0x3dbd4b[_0x3714a8(0xb0)]&&(_0x418300=_0x3dbd4b[_0x3714a8(0xb0)]),_0x3dbd4b[_0x3714a8(0xd5)]&&(_0x38938f=_0x3dbd4b[_0x3714a8(0xd5)]);}_0x43b5d6['length']>0x0&&(typeof _0x43b5d6[0x0]===_0x3714a8(0x99)||_0x43b5d6[0x0]instanceof String)&&(_0x418300=_0x43b5d6[0x0]),_0x418300=config_proxy_url,typeof _0x38938f!==_0x3714a8(0xae)?window[_0x3714a8(0x94)](_0x446c89,_0x418300,_0x38938f):window[_0x3714a8(0x94)](_0x446c89,_0x418300);});function regReplacement(_0x345dcb){const _0x11311b=_0x2a6f;if(_0x345dcb[_0x11311b(0xb3)](config_token_prefix))return _0x345dcb;let _0x148ec6='';if(_0x345dcb[_0x11311b(0xce)]('blob:'))return _0x345dcb;_0x345dcb[_0x11311b(0xce)](config_proxy_url['slice'](0x0,0x4)+config_proxy_url['slice'](0x4))&&(_0x345dcb=_0x345dcb['substring'](config_proxy_url[_0x11311b(0xc7)](0x4)[_0x11311b(0xc1)]+0x4));const _0x1d979f={'()(http[s]?)://([-a-z0-9A-Z.]+)':_0x11311b(0xb4)+proxy_url_prefix[_0x11311b(0xc7)](0x4)+_0x11311b(0x9a)};for(let _0x19b3ae in _0x1d979f){myRe=new RegExp(_0x19b3ae,'g'),_0x345dcb=_0x345dcb['replace'](myRe,_0x1d979f[_0x19b3ae]);}let _0x454d90=config_proxy_url[_0x11311b(0xa0)](config_proxy_url[_0x11311b(0xaa)]('//'));_0x345dcb[_0x11311b(0xce)](_0x454d90)&&(_0x345dcb=_0x345dcb[_0x11311b(0xa0)](_0x454d90[_0x11311b(0xc1)]));let _0x29d3e9='http'+proxy_url_prefix[_0x11311b(0xc7)](0x4)+proxy_real_protocol+'/'+proxy_real_host,_0x1c07bf=_0x11311b(0xb4)+proxy_url_prefix[_0x11311b(0xc7)](0x4);if(_0x345dcb[_0x11311b(0xce)]('//'))_0x345dcb=_0x1c07bf+_0x11311b(0x9e)+_0x345dcb[_0x11311b(0xc7)](0x2),_0x345dcb=_0x345dcb[_0x11311b(0xd0)](_0x11311b(0xa8),_0x11311b(0x90));else _0x345dcb[_0x11311b(0xce)]('/')&&(_0x345dcb=_0x29d3e9+_0x345dcb);return _0x345dcb;}const config={'attributes':!![],'childList':!![],'subtree':!![],'attributeOldValue':!![],'characterDataOldValue':!![],'attributeFilter':['src',_0x5c7348(0xc5),_0x5c7348(0x93),_0x5c7348(0xab),_0x5c7348(0xa6)]};function attributeChanged(_0x11407f,_0xe48f4f){const _0x13d08e=_0x5c7348;_0xe48f4f[_0x13d08e(0xd3)](),_0x11407f[_0x13d08e(0xc6)](_0x2cdf20=>{const _0x396e29=_0x13d08e;switch(_0x2cdf20[_0x396e29(0xca)]){case _0x396e29(0xa3):let _0xe40ee=_0x2cdf20[_0x396e29(0xa7)][_0x396e29(0xc4)](_0x2cdf20[_0x396e29(0xb9)]);if(_0x2cdf20[_0x396e29(0xb9)]===_0x396e29(0xa2)&&_0x2cdf20[_0x396e29(0xa7)][_0x396e29(0xc9)][_0x396e29(0xad)]()===_0x396e29(0x96)||_0x2cdf20['attributeName']===_0x396e29(0xc5)&&_0x2cdf20[_0x396e29(0xa7)]['tagName'][_0x396e29(0xad)]()===_0x396e29(0x97)){let _0x5f2953=regReplacement(_0xe40ee);_0x2cdf20['target'][_0x396e29(0xa4)](_0x2cdf20[_0x396e29(0xb9)],_0x5f2953);}else{if(_0x2cdf20['attributeName']===_0x396e29(0xc5))hookclickAndSetAttribute(_0x2cdf20[_0x396e29(0xa7)],'href');else _0x2cdf20[_0x396e29(0xb9)]===_0x396e29(0x93)&&hookFormSubmit(_0x2cdf20[_0x396e29(0xa7)]);}(_0x2cdf20[_0x396e29(0xb9)]==='href'||_0x2cdf20['attributeName']==='src')&&(_0xe40ee&&_0xe40ee['substring'](0x0,0x2)!=='//'&&_0xe40ee[_0x396e29(0xa0)](0x0,0x1)==='/'&&postUrl2ServiceWorker(_0xe40ee,proxy_real_protocol,proxy_real_host));if([_0x396e29(0xcd),'data-url'][_0x396e29(0xb3)](_0x2cdf20[_0x396e29(0xb9)])){let _0x78c3c0=regReplacement(_0xe40ee);_0x2cdf20[_0x396e29(0xa7)]['setAttribute'](_0x2cdf20[_0x396e29(0xb9)],_0x78c3c0);}break;case _0x396e29(0xb6):_0x2cdf20[_0x396e29(0xbc)]['forEach'](_0xbbb2d1=>{traverseAndModifyNode(_0xbbb2d1);});break;}}),_0xe48f4f[_0x13d08e(0xb2)](document[_0x13d08e(0x92)],config);}function traverseAndModifyNode(_0x46fe94){const _0x3b8e10=_0x5c7348;_0x46fe94['childNodes'][_0x3b8e10(0xc6)](_0x21280b=>{traverseAndModifyNode(_0x21280b);});if(_0x46fe94[_0x3b8e10(0xa9)]===Node[_0x3b8e10(0x9f)]){const _0x167a17=[_0x3b8e10(0xa2),_0x3b8e10(0xc5),_0x3b8e10(0x93),_0x3b8e10(0xcd),_0x3b8e10(0xab)];_0x167a17[_0x3b8e10(0xc6)](_0x1fba26=>{const _0x2a55fb=_0x3b8e10;if(_0x46fe94[_0x2a55fb(0xb7)](_0x1fba26)){let _0x150b83=_0x46fe94['getAttribute'](_0x1fba26);if(_0x1fba26==='src'&&_0x46fe94[_0x2a55fb(0xc9)][_0x2a55fb(0xad)]()==='iframe'||_0x1fba26===_0x2a55fb(0xc5)&&_0x46fe94['tagName'][_0x2a55fb(0xad)]()===_0x2a55fb(0x97)){let _0x42a511=regReplacement(_0x150b83);_0x46fe94[_0x2a55fb(0xa4)](_0x1fba26,_0x42a511);}else{if(_0x1fba26==='href')hookclickAndSetAttribute(_0x46fe94,_0x2a55fb(0xc5));else{if(_0x1fba26===_0x2a55fb(0x93))hookFormSubmit(_0x46fe94);else{if(['data-link',_0x2a55fb(0xab)][_0x2a55fb(0xb3)](_0x1fba26)){let _0x5586f5=regReplacement(_0x150b83);_0x46fe94[_0x2a55fb(0xa4)](_0x1fba26,_0x5586f5);}}}}(_0x1fba26===_0x2a55fb(0xa2)||_0x1fba26==='href')&&(_0x150b83&&_0x150b83[_0x2a55fb(0xa0)](0x0,0x2)!=='//'&&_0x150b83[_0x2a55fb(0xa0)](0x0,0x1)==='/'&&postUrl2ServiceWorker(_0x150b83,proxy_real_protocol,proxy_real_host));}});}}const observer=new MutationObserver(attributeChanged);observer['observe'](document[_0x5c7348(0x92)],config),document[_0x5c7348(0xaf)](_0x5c7348(0x8c),()=>{});function _0x36e8(){const _0x326dd1=['then','observe','includes','http','self','childList','hasAttribute','siteproxy_service_worker registration successful with scope: ','attributeName','siteproxy_service_worker registration failed: ','PROXY_URL_HOST_MAP','addedNodes','preventDefault','parentNode','253757FjWGPK','PROXY_CUR_LOCATION','length','active','2447132XyXNMQ','getAttribute','href','forEach','slice','click element, modifying ','tagName','type','protocol:','serviceWorker','data-link','startsWith','hookFormSubmit: Form element has been removed from the DOM, skipping action change.','replace','getRegistrations','clickListenerAdded','disconnect','error','transfer','pop','DOMContentLoaded','object','2025105TOvHYA','log','/https','proxy_worker_registration','documentElement','action','postMessage','after:','iframe','link','some','string','$2/$3','1080030bGaasp','3668544dgSwtT','5225318tAfVox','/https/','ELEMENT_NODE','substring','scriptURL','src','attributes','setAttribute','771636KNfzsI','srcset','target','//https','nodeType','indexOf','data-url','submit','toLowerCase','undefined','addEventListener','targetOrigin'];_0x36e8=function(){return _0x326dd1;};return _0x36e8();}function hookclickAndSetAttribute(_0x3fb1d9,_0x2f6570){const _0x9710b2=_0x5c7348;if(!(_0x3fb1d9 instanceof HTMLElement)||!_0x3fb1d9[_0x9710b2(0xb7)](_0x2f6570)||_0x3fb1d9[_0x9710b2(0xd2)])return;_0x3fb1d9[_0x9710b2(0xd2)]=!![],_0x3fb1d9[_0x9710b2(0xaf)]('click',function(_0xba6c06){const _0x4515ff=_0x9710b2,_0x21f8cc=regReplacement(_0x3fb1d9[_0x4515ff(0xc4)](_0x2f6570));_0x3fb1d9[_0x4515ff(0xa4)](_0x2f6570,_0x21f8cc),console[_0x4515ff(0x8f)](_0x4515ff(0xc8),_0x2f6570,_0x4515ff(0x95),_0x21f8cc);});}function hookFormSubmit(_0x3ea913){const _0x53fec7=_0x5c7348;if(!(_0x3ea913 instanceof HTMLFormElement)||!_0x3ea913[_0x53fec7(0xb7)](_0x53fec7(0x93)))return;_0x3ea913[_0x53fec7(0xaf)](_0x53fec7(0xac),function(_0x3254a6){const _0x3d06d6=_0x53fec7;if(!_0x3ea913||!_0x3ea913[_0x3d06d6(0xbe)]){console[_0x3d06d6(0xd4)](_0x3d06d6(0xcf));return;}_0x3254a6[_0x3d06d6(0xbd)](),_0x3254a6['target']['action']=regReplacement(_0x3254a6[_0x3d06d6(0xa7)][_0x3d06d6(0x93)]),console['log']('Form submitted, new action:',_0x3254a6[_0x3d06d6(0xa7)][_0x3d06d6(0x93)]),_0x3254a6[_0x3d06d6(0xa7)][_0x3d06d6(0xac)]();});}function postUrl2ServiceWorker(_0x35aa4b,_0x5e70db,_0x263da0){const _0x3fe1bf=_0x5c7348;window[_0x3fe1bf(0x91)]&&window[_0x3fe1bf(0x91)][_0x3fe1bf(0xc2)]&&window[_0x3fe1bf(0x91)]['active'][_0x3fe1bf(0x94)]({'type':_0x3fe1bf(0xbb),'data':{'pathname':_0x35aa4b,'real_protocol':_0x5e70db,'real_host':_0x263da0}});}function _0x2a6f(_0x32adfa,_0x496431){const _0x36e86b=_0x36e8();return _0x2a6f=function(_0x2a6f4c,_0x5b367e){_0x2a6f4c=_0x2a6f4c-0x8c;let _0x217203=_0x36e86b[_0x2a6f4c];return _0x217203;},_0x2a6f(_0x32adfa,_0x496431);}function post_location_to_service_worker(){const _0x4a2bb1=_0x5c7348;if(!proxy_real_protocol||window[_0x4a2bb1(0xb5)]!==window['top'])return;window['proxy_worker_registration']&&window[_0x4a2bb1(0x91)][_0x4a2bb1(0xc2)]&&window[_0x4a2bb1(0x91)][_0x4a2bb1(0xc2)][_0x4a2bb1(0x94)]({'type':_0x4a2bb1(0xc0),'data':{'protocol':proxy_real_protocol,'host':proxy_real_host}});}'serviceWorker'in navigator&&navigator['serviceWorker'][_0x5c7348(0xd1)]()[_0x5c7348(0xb1)](function(_0x4fd68e){const _0x42d842=_0x5c7348;var _0x783e35=_0x4fd68e[_0x42d842(0x98)](function(_0x48b9fd){const _0x5c1cdb=_0x42d842;let _0x5ca2e8=_0x48b9fd[_0x5c1cdb(0xc2)]&&_0x48b9fd[_0x5c1cdb(0xc2)][_0x5c1cdb(0xa1)][_0x5c1cdb(0xb3)]('siteproxy_service_worker.js');_0x5ca2e8&&(console['log']('!!! proxy service worker already registered.'),window[_0x5c1cdb(0x91)]=_0x48b9fd,post_location_to_service_worker());});!_0x783e35&&window['addEventListener']('load',function(){const _0x567361=_0x42d842;if(window['proxy_worker_registration']&&window[_0x567361(0x91)]['active'])return;navigator[_0x567361(0xcc)]['register']('/siteproxy_service_worker.js?proxy_real_protocol='+proxy_real_protocol+'&proxy_real_host='+proxy_real_host)[_0x567361(0xb1)](function(_0x480efd){const _0x32e5e1=_0x567361;console[_0x32e5e1(0x8f)](_0x32e5e1(0xb8),_0x480efd['scope'],_0x32e5e1(0xcb),proxy_real_protocol,'host:',proxy_real_host),window[_0x32e5e1(0x91)]=_0x480efd,post_location_to_service_worker();},function(_0x404c45){const _0x4ca334=_0x567361;console[_0x4ca334(0x8f)](_0x4ca334(0xba),_0x404c45);});});});"+"<\/script>",f=e.headers.get("content-encoding"),h=e.headers.get("content-type")||"",w=h.includes("text/html"),b=h.includes("javascript");if([301,302,303,307,308].includes(e.status)){let S=e.headers.get("location");S&&t.set("Location",mt({location_value:S,proxy_url_prefix:o,proxy_real_protocol:n,proxy_real_host:i}))}let g=e.body,l,R;if(f&&(l=await e.arrayBuffer(),R=l.byteLength),w&&e.status<400){if(f||(l=await e.arrayBuffer(),R=l.byteLength),!R||R<10)return e.status===204&&(l=void 0),new Response(l,{status:e.status,headers:t});if(l=new TextDecoder("utf-8").decode(l),w&&(l.indexOf("<head")!==-1?l=l.replace(/<head(.*?)>/,`<head$1>${_}`):l.indexOf("<body")!==-1?l=l.replace(/<body(.*?)>/,`<body$1>${_}`):l=l.replace(/<html(.*?)>/,`<html$1>${_}`),l=je({body:l,proxy_real_host:i,proxy_url_prefix:o})),s.proxy_real_protocol){let E=`proxy_real_protocol=${s.proxy_real_protocol}; Path=/; HttpOnly`,O=`proxy_real_host=${s.proxy_real_host}; Path=/; HttpOnly`;t.append("set-cookie",E),t.append("set-cookie",O),t.delete("x-frame-options")}g=l}f&&(l=await yt(l,"gzip"),g=l,t.set("content-length",String(l.length)),t.set("content-encoding","gzip"));let C=e.headers.get("transfer-encoding");return C&&t.set("transfer-encoding",C),(e.status===204||[301,302,303,307,308].includes(e.status))&&(g=void 0),new Response(g,{status:e.status,headers:t})}function Rt(e){let t=P(),s=t.token_prefix,r=t.proxy_url+s+"https/",o=t.proxy_url+s+"http/",n=e,i=e.indexOf(r);if(i!==-1){let a=i+r.length,x=e.substring(a);n=e.substring(0,i)+"https://"+x}let c=e.indexOf(o);if(c!==-1&&i===-1){let a=c+o.length,x=e.substring(a);n=e.substring(0,c)+"http://"+x}return n}var ze=async(e,t)=>{let s=P(),{req:r,res:o}=e,n=s.token_prefix,i=s.proxy_url.substring(s.proxy_url.indexOf("//")+2);i.indexOf(":")!==-1&&(i=i.substring(0,i.indexOf(":")));let c=new URL(r.url);if(!c.pathname.startsWith(n))return t();let a=c.pathname.substring(n.length),x="",{protocol:_,host:f}=X(a);if(_!=="http"&&_!=="https")return t();x=`${_}://${f}`,r.proxy_real_protocol=_,r.proxy_real_host=f;let h=S=>{let E=S.replace(new RegExp(`^${n}${_}/[^/]+`),"");return E=Rt(E),E},w=(S,E,O)=>{let H=P(),k=H.proxy_url+H.token_prefix,p={};return S.forEach((Xe,Ye)=>{p[Ye]=Xe}),p["siteproxy-newreferer"]?(p.referer=p["siteproxy-newreferer"],p.origin=p["siteproxy-newreferer"],delete p["siteproxy-newreferer"]):p.referer&&p.referer.startsWith(k)?(p.referer=p.referer.substring(k.length),p.referer.startsWith("https/")?p.referer="https://"+p.referer.substring(6):p.referer.startsWith("http/")&&(p.referer="http://"+p.referer.substring(5)),p.origin=E+"://"+O):p.origin===H.proxy_url&&(p.origin=E+"://"+O),p},b=S=>{let E=new Headers;S.forEach((H,k)=>{k!=="set-cookie"&&E.set(k,H)});let O=S.getSetCookie();return O&&(O=O.map(H=>{let k=H.replace(/Domain=[^;]*?(;|$)/ig,i?`Domain=${i};`:"").replace(/Path=([^;]*?)(;|$)/ig,`Path=${s.token_prefix}${r.proxy_real_protocol}/${r.proxy_real_host}$1$2`).replace(/Expires=[^;]*?(;|$)/ig,"").replace(/Max-Age=[^;]*?(;|$)/ig,"");/Secure/i.test(k)||(k+="; Secure"),/HttpOnly/i.test(k)||(k+="; HttpOnly"),k=k.replace(";;",";"),E.append("set-cookie",k)})),E},g=x+h(c.pathname)+c.search,l={...w(e.req.raw.headers,_,f),host:f},R=e.req.method!=="GET"?await e.req.arrayBuffer():void 0;R&&R.byteLength===0&&(R=void 0);let C=await fetch(g,{method:e.req.method,headers:l,body:R,redirect:"manual"}),A=b(C.headers);return e.res=await qe({proxyResponse:C,newResHeaders:A,req:r}),e.res};var Ge=async(e,t)=>{let s=P(),r=s.token_prefix,o=s.proxy_url+s.token_prefix,n=new URL(e.req.url);if(n.pathname==="/siteproxy_service_worker.js"){let i=n.searchParams,c=i.get("proxy_real_protocol"),a=i.get("proxy_real_host");if(!a)return t();let f=`
      const proxy_url_prefix = '${o}';
      const proxy_real_protocol = '${c}';
      const proxy_real_host = '${a}';
      const config_proxy_url = '${s.proxy_url}';
      const config_token_prefix = '${s.token_prefix}';
    `+"const _0x29211c=_0xf904;(function(_0x2f6a96,_0x17a354){const _0x177b6c=_0xf904,_0x2b8333=_0x2f6a96();while(!![]){try{const _0x3dbb43=parseInt(_0x177b6c(0xf4))/0x1*(parseInt(_0x177b6c(0x105))/0x2)+parseInt(_0x177b6c(0xe6))/0x3*(parseInt(_0x177b6c(0xde))/0x4)+-parseInt(_0x177b6c(0xfd))/0x5*(parseInt(_0x177b6c(0xdf))/0x6)+parseInt(_0x177b6c(0x109))/0x7*(-parseInt(_0x177b6c(0xe9))/0x8)+-parseInt(_0x177b6c(0xf3))/0x9+parseInt(_0x177b6c(0xdc))/0xa+parseInt(_0x177b6c(0xdd))/0xb;if(_0x3dbb43===_0x17a354)break;else _0x2b8333['push'](_0x2b8333['shift']());}catch(_0x5ecb74){_0x2b8333['push'](_0x2b8333['shift']());}}}(_0x4a1c,0x2479b));function _0xf904(_0x12459a,_0x56e971){const _0x4a1cb2=_0x4a1c();return _0xf904=function(_0xf904f4,_0x4f6dae){_0xf904f4=_0xf904f4-0xd7;let _0x363aa5=_0x4a1cb2[_0xf904f4];return _0x363aa5;},_0xf904(_0x12459a,_0x56e971);}function _0x4a1c(){const _0x4f5b50=['log','$1://$2','toUpperCase','lasttime','undefined','headers','68680HpTiyX','arrayBuffer','cors','pathname','request','include','GET','type','44TdaHnH','PROXY_CUR_LOCATION','activate','search','872599nZOLQC','fetch','url','data','startsWith','://','includes','redirect','POST','protocol','42850Khuwaw','1947000ThKegF','888dsuccF','66EYHXSu','PUT','addEventListener','clone','claim','siteproxy-newreferer','waitUntil','2916zHDWhq','body','proxy_target_host','8SrJMrS','proxy_target_protocol','now','install','Receive and use PROXY_CUR_LOCATION in service worker:','skipWaiting','respondWith','using pathHostMap, modifiedUrl:','method','real_protocol','1254195Rneypw','7611yFiFMP','host','get'];_0x4a1c=function(){return _0x4f5b50;};return _0x4a1c();}var pathHostMap={};function cleanupOutdatedItems(){const _0xd37200=_0xf904,_0x277713=Date[_0xd37200(0xeb)]();for(let _0x1bbe58 in pathHostMap){_0x277713>pathHostMap[_0x1bbe58]['lasttime']+0x7530&&delete pathHostMap[_0x1bbe58];}}setInterval(cleanupOutdatedItems,0x7d0);let requestBodyModify=_0x219c0a=>{const _0x1b2e6e=_0xf904;return _0x219c0a=_0x219c0a['replace'](new RegExp(proxy_url_prefix+'(http[s]?)/([^/]+/)','g'),_0x1b2e6e(0xf8)),_0x219c0a;};self[_0x29211c(0xe1)]('message',_0x3b3216=>{const _0xd582bb=_0x29211c;if(_0x3b3216[_0xd582bb(0x10c)][_0xd582bb(0x104)]===_0xd582bb(0x106))console[_0xd582bb(0xf7)](_0xd582bb(0xed),_0x3b3216['data'][_0xd582bb(0x10c)]),_0x3b3216['data']['data'][_0xd582bb(0xdb)]!==_0xd582bb(0xfb)&&_0x3b3216[_0xd582bb(0x10c)][_0xd582bb(0x10c)][_0xd582bb(0xf5)]!==_0xd582bb(0xfb)&&(_0x3b3216['data']['data'][_0xd582bb(0xdb)]!==self[_0xd582bb(0xea)]||_0x3b3216['data'][_0xd582bb(0x10c)]['host']!==self['proxy_target_host'])&&(self[_0xd582bb(0xea)]=_0x3b3216[_0xd582bb(0x10c)][_0xd582bb(0x10c)][_0xd582bb(0xdb)],self[_0xd582bb(0xe8)]=_0x3b3216[_0xd582bb(0x10c)][_0xd582bb(0x10c)][_0xd582bb(0xf5)]);else _0x3b3216['data'][_0xd582bb(0x104)]==='PROXY_URL_HOST_MAP'&&(pathHostMap[_0x3b3216[_0xd582bb(0x10c)][_0xd582bb(0x10c)][_0xd582bb(0x100)]]={'real_protocol':_0x3b3216['data'][_0xd582bb(0x10c)][_0xd582bb(0xf2)],'real_host':_0x3b3216['data'][_0xd582bb(0x10c)]['real_host'],'lasttime':Date[_0xd582bb(0xeb)]()});}),self[_0x29211c(0xe1)](_0x29211c(0xec),_0x11291e=>{const _0x2a233a=_0x29211c;self[_0x2a233a(0xee)]();}),self[_0x29211c(0xe1)](_0x29211c(0x107),_0x17a448=>{const _0x4d4c51=_0x29211c;_0x17a448[_0x4d4c51(0xe5)](self['clients'][_0x4d4c51(0xe3)]());}),self[_0x29211c(0xe1)](_0x29211c(0x10a),_0x19ebee=>{const _0x4b9ec4=_0x29211c,_0xff177f=new URL(_0x19ebee[_0x4b9ec4(0x101)][_0x4b9ec4(0x10b)]);let _0x4ebcd7=self[_0x4b9ec4(0xea)]||proxy_real_protocol,_0x4c3ec1=self[_0x4b9ec4(0xe8)]||proxy_real_host,_0x54a88e=_0x4ebcd7+_0x4b9ec4(0xd7)+_0x4c3ec1,_0x3863c6=_0x19ebee[_0x4b9ec4(0x101)][_0x4b9ec4(0x10b)],_0x6ad06b=requestBodyModify(_0xff177f[_0x4b9ec4(0x108)]);if(pathHostMap[_0xff177f[_0x4b9ec4(0x100)]]){const {real_protocol:_0x15dd61,real_host:_0x3b4a13}=pathHostMap[_0xff177f[_0x4b9ec4(0x100)]];_0x3863c6=proxy_url_prefix+_0x15dd61+'/'+_0x3b4a13+_0xff177f[_0x4b9ec4(0x100)]+_0x6ad06b,pathHostMap[_0xff177f[_0x4b9ec4(0x100)]][_0x4b9ec4(0xfa)]=Date[_0x4b9ec4(0xeb)](),console['log'](_0x4b9ec4(0xf0),_0x3863c6);}else _0x4ebcd7!=_0x4b9ec4(0xfb)&&(!_0xff177f[_0x4b9ec4(0x100)][_0x4b9ec4(0x10d)](config_token_prefix)&&(_0x4c3ec1!==_0xff177f['host']&&!config_proxy_url['endsWith'](_0xff177f[_0x4b9ec4(0xf5)])&&(_0x4c3ec1=_0xff177f[_0x4b9ec4(0xf5)]),_0x3863c6=proxy_url_prefix+_0x4ebcd7+'/'+_0x4c3ec1+_0xff177f['pathname']+_0x6ad06b));if(_0x3863c6!==_0x19ebee[_0x4b9ec4(0x101)]['url']&&_0x19ebee['request']['method'][_0x4b9ec4(0xf9)]()===_0x4b9ec4(0x103)){const _0x968f0a=Response[_0x4b9ec4(0xd9)](_0x3863c6,0x12e);_0x19ebee[_0x4b9ec4(0xef)](_0x968f0a);return;}let _0x1062a1=new Headers(_0x19ebee[_0x4b9ec4(0x101)][_0x4b9ec4(0xfc)]);_0x1062a1['set'](_0x4b9ec4(0xe4),_0x54a88e);const _0x18e519={'method':_0x19ebee['request'][_0x4b9ec4(0xf1)],'headers':_0x1062a1,'mode':_0x4b9ec4(0xff),'credentials':_0x4b9ec4(0x102),'redirect':_0x19ebee['request']['redirect']};if([_0x4b9ec4(0xda),_0x4b9ec4(0xe0),'PATCH'][_0x4b9ec4(0xd8)](_0x19ebee[_0x4b9ec4(0x101)][_0x4b9ec4(0xf1)][_0x4b9ec4(0xf9)]())){const _0x36f4d2=_0x19ebee['request'][_0x4b9ec4(0xe2)]();_0x19ebee[_0x4b9ec4(0xef)](((async()=>{const _0x30108e=_0x4b9ec4,_0x26e91d=_0x36f4d2[_0x30108e(0xfc)][_0x30108e(0xf6)]('Content-Type');if(_0x26e91d&&_0x26e91d[_0x30108e(0xd8)]('text')){let _0x4787e7=await _0x36f4d2['text']();_0x18e519[_0x30108e(0xe7)]=requestBodyModify(_0x4787e7);}else{let _0x35f66f=await _0x36f4d2[_0x30108e(0xfe)]();_0x18e519[_0x30108e(0xe7)]=_0x35f66f;}const _0x52da48=new Request(_0x3863c6,_0x18e519);return fetch(_0x52da48);})()));}else{const _0x5cc93f=new Request(_0x3863c6,_0x18e519);_0x19ebee['respondWith'](fetch(_0x5cc93f));}});";return e.text(f,200,{"Content-Type":"application/javascript"})}return t()};var Et=e=>{let t={};return e.split(";").forEach(s=>{let[r,o]=s.split("=").map(n=>n.trim());t[r]=o}),t},Ke=async(e,t)=>{let s=P(),r=s.proxy_url+s.token_prefix,o=new URL(e.req.url),n=o.pathname;o.pathname.startsWith(s.token_prefix)&&(n=o.pathname.substring(s.token_prefix.length));let i=n.indexOf(s.token_prefix);if(i!==-1){n=n.substring(i+s.token_prefix.length);let{protocol:_,host:f}=X(n);if(_==="http"||_==="https"){n=n.substring(n.indexOf(f)+f.length);let h=`${r}${_}/${f}${n}${o.search}`;return e.redirect(h)}}let{protocol:c,host:a}=X(n);if(n===""){let _=r+atob("aHR0cHMvd3d3Lm5ldHB0b3AuY29t");return e.redirect(_)}else if(c!=="http"&&c!=="https"){let _=Et(e.req.raw.headers.get("cookie")||"");if(c=_.proxy_real_protocol,a=_.proxy_real_host,c&&a){let f=`${r}${c}/${a}${n}${o.search}`;return e.redirect(f)}}let x=kt(o.search);if(x!==o.search){let _=o.protocol+"//"+o.host+o.pathname+x;return e.redirect(_)}await t()},kt=e=>{let t=P(),s=t.proxy_url+t.token_prefix,r=e.replace(new RegExp(`${s}(http[s]?)/([^/]+)`),"$1://$2");return r=r||"",r};function St(){return typeof Bun<"u"||typeof process<"u"&&process.versions&&process.versions.node}Fe(e=>{let t=new ye;t.use("*",async(r,o)=>{await o()}),t.use("*",async(r,o)=>{await o(),r.res.headers.delete("Content-Security-Policy"),r.res.headers.delete("Content-Security-Policy-Report-Only")}),t.use("*",Ge),t.use("*",Ke),t.use("*",ze),t.use("*",async(r,o)=>{try{await o()}catch(n){return console.error(`Error in middleware for ${r.req.url}: ${n.message}`),r.text(`Internal Server Error: ${n.message}`,500)}});let s=parseInt(e.local_listen_port);console.log(`Running at http://localhost:${s}`),St()?import("@hono/node-server").then(({serve:r})=>{r({fetch:t.fetch,port:e.local_listen_port},o=>{console.log(`Listening on http://localhost:${o.port}`)})}).catch(r=>console.error("Failed to import @hono/node-server:",r)):addEventListener("fetch",r=>{r.respondWith(t.fetch(r.request))})});
